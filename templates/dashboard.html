{% extends "base.html" %}

{% block title %}Dashboard - NLBM Blog Tool{% endblock %}

{% block extra_css %}
<style>
    .article-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* Article icon styling */
    .article-icon {
        font-size: 1.5rem;
        color: #0E2539;
        margin-bottom: 1rem;
        text-align: left;
    }

    .tone-option {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    .tone-option:hover {
        background-color: #f8f9fa;
    }
    .tone-option.selected {
        border-color: #0E2539;
        background-color: #f0f7ff;
    }

    .keyword-container {
        margin-bottom: 1rem;
    }
    .keyword-badge {
        cursor: pointer;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .selected-keyword {
        background-color: #0d6efd !important;
    }
    .stored-keyword {
        background-color: #6c757d !important;
    }
    .keyword-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .remove-keyword {
        cursor: pointer;
        margin-left: 0.25rem;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0E2539;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .filter-btn {
        transition: all 0.2s;
    }
    .filter-btn.active {
        background-color: #0E2539;
        color: white;
        border-color: #0E2539;
    }
    .btn-group {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .btn-group .btn {
        margin: 0;
    }

    #articles-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .article-card {
        transition: all 0.3s ease;
        break-inside: avoid;
        margin-bottom: 1rem;
    }

    /* For filtered views */
    .flex-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .flex-layout .article-card {
        flex: 1 1 300px;
        max-width: calc(33.333% - 1rem);
    }

    /* Preview button styles */
    .preview-btn {
        background: none;
        border: none;
        color: var(--nlbm-primary);
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .preview-btn:hover {
        color: var(--nlbm-secondary);
    }

    .preview-btn i {
        width: 16px;
        height: 16px;
    }

    /* Article header with preview button */
    .article-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    /* Slide-in preview dialog */
    .preview-dialog {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: left 0.3s ease-in-out;
        overflow-y: auto;
    }

    .preview-dialog.active {
        left: 0;
    }

    .preview-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .preview-content {
        padding: 1.5rem;
    }

    .preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .preview-overlay.active {
        display: block;
    }

    .close-preview {
        background: none;
        border: none;
        color: var(--nlbm-medium-gray);
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
    }

    .close-preview:hover {
        color: var(--nlbm-dark-gray);
    }

    /* Fix for floating buttons */
    .info-edit-mode {
        position: relative;
        overflow: hidden;
    }

    .info-edit-mode .mt-3 {
        position: relative;
        z-index: 1;
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
    }

    .save-info-btn,
    .cancel-edit-btn {
        position: relative;
        z-index: 2;
    }

    /* Fix for edit mode affecting other cards */
    .collapse {
        position: relative;
        z-index: 1;
    }

    .card-body {
        position: relative;
    }

    /* Ensure each card maintains its own height independently */
    .article-card {
        height: auto !important;
        min-height: 100%;
        display: flex;
        flex-direction: column;
    }

    .article-card .card-body {
        height: auto !important;
        min-height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Push buttons to bottom of card */
    .article-card .card-body > *:not(.article-header):not(.article-title):not(.article-description) {
        margin-top: auto;
    }

    /* Ensure edit mode doesn't affect other cards */
    .collapse.show {
        margin-top: 1rem;
    }

    /* Save message styling */
    .save-message {
        position: relative;
        z-index: 3;
        margin-top: 0.75rem !important;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        animation: fadeInUp 0.3s ease-out;
    }

    .save-message.alert-success {
        background-color: #d1e7dd;
        border: 1px solid #badbcc;
        color: #0f5132;
    }

    .save-message.alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        color: #842029;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Add preview dialog -->
<div class="preview-overlay" id="previewOverlay"></div>
<div class="preview-dialog" id="previewDialog">
    <div class="preview-header">
        <h3 class="preview-title mb-0">Article Preview</h3>
        <button class="close-preview" id="closePreview">
            <i data-feather="x"></i>
        </button>
    </div>
    <div class="preview-content" id="previewContent">
        <!-- Content will be loaded here -->
    </div>
</div>

<div class="card shadow-sm">
    <!-- Toast notification -->
    <div class="toast-container">
        <div id="toast" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Dashboard header -->
    <div class="card-header bg-white">
        <div class="d-flex flex-column">
            <h1 class="h3 mb-0">Choose an Article to Customize</h1>
            <div class="instructions text-muted">
                <p class="mb-1"><small>
                    
                    Select one of the following PFL articles, your preferred writing tone and keywords to customize for your firm.
                    You can come back to this screen to customize another article after you're done.
                </small></p>
            </div>
        </div>
    </div>

    <!-- Add filter controls -->
    <div class="card-body border-bottom">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <span class="me-2">Filter:</span>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="latest">Latest</button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="all">All Articles</button>
            </div>
            {% if series_list %}
            <div class="btn-group" role="group">
                {% for series in series_list %}
                <button type="button" class="btn btn-outline-primary filter-btn" 
                        data-filter="series-{{ loop.index }}"
                        data-series="{{ series }}">
                    {{ series }}
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main content area-->
    <div class="card-body">
        {% if articles %}
        <div class="row">
            {% for article in articles %}
            {% set article_index = loop.index %}
            {% set meta = metadata.get(article, {}) %}
            
            <!-- Article card -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card article-card"
                    data-series="{{ meta.series if meta.series else 'none' }}"
                    data-series-index="{{ meta.series_order if meta.series_order else 0 }}"
                    data-publish-date="{{ meta.publish_date if meta.publish_date else '' }}">
                    <div class="card-body">
                        <!-- Article header with preview button -->
                        <div class="article-header">
                        <div class="article-icon">
                            <i data-feather="file-text"></i>
                            </div>
                            <button class="preview-btn" data-article="{{ article }}" title="Preview Article">
                                <i data-feather="eye"></i>
                                <span>Preview</span>
                            </button>
                        </div>
                        
                        <!-- Article title -->
                        <h2 class="article-title">
                            {% if meta and meta.title %}{{ meta.title }}{% else %}{{ article }}{% endif %}
                        </h2>
                        
                        <!-- Article description -->
                        {% if meta and meta.description %}
                            <p class="article-description">{{ meta.description }}</p>
                        {% endif %}
                        
                        <!-- Article selection form -->
                        <form method="POST" action="{{ url_for('select_article', article=article) }}" class="mb-3 article-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-primary w-100">
                                <i data-feather="edit-2" class="icon-sm me-1"></i>Generate Article
                            </button>
                        </form>
                        
                        <!-- Article details preview -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center edit-info-btn" type="button">
                                    <i data-feather="edit" class="icon-sm me-2"></i>
                                    <h3 class="h6 mb-0">Edit Your Firm's Info</h3>
                                </button>
                            </div>
                            <div class="collapse" id="userInfoCollapse{{ article_index }}">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <!-- View Mode -->
                                        <div class="info-view-mode">
                                            <p class="mb-2"><strong>Firm Name:</strong> <span class="firm-value">{{ user.firm }}</span></p>
                                            <p class="mb-2"><strong>Your City/Region:</strong> <span class="location-value">{{ user.location }}</span></p>
                                            <p class="mb-2"><strong>Name:</strong> <span class="lawyer-name-value">{{ user.lawyer_name }}</span></p>
                                            <p class="mb-2"><strong>State:</strong> <span class="state-value">{{ user.state }}</span></p>
                                            {% if user.address %}
                                            <p class="mb-2"><strong>Address:</strong> <span class="address-value">{{ user.address }}</span></p>
                                            {% endif %}
                                            <p class="mb-2"><strong>Planning Session:</strong> <span class="planning-session-value">{{ user.planning_session }}</span></p>
                                            {% if user.other_planning_session %}
                                            <p class="mb-2"><strong>Other Planning Session:</strong> <span class="other-planning-session-value">{{ user.other_planning_session }}</span></p>
                                            {% endif %}
                                            {% if user.discovery_call_link %}
                                            <p class="mb-2"><strong>Discovery Call Link:</strong> <span class="discovery-call-link-value">{{ user.discovery_call_link }}</span></p>
                                            {% endif %}
                                            
                                            <!-- Tone and Keywords in View Mode -->
                                            <div class="mt-3 pt-2 border-top">
                                                <p class="mb-2"><strong>Writing Tone:</strong> 
                                                    <span class="selected-tone-value">
                                                        {% if user.selected_tone %}{{ user.selected_tone }}{% else %}Professional{% endif %}
                                                    </span>
                                                </p>
                                                <p class="mb-2 text-muted small selected-tone-description">
                                                    {% if user.selected_tone and user.tone_description %}
                                                        {{ user.tone_description }}
                                                    {% elif user.selected_tone %}
                                                        {% for tone, desc in tone_descriptions.items() %}
                                                            {% if tone == user.selected_tone %}{{ desc }}{% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Formal and business-like tone suitable for corporate audiences
                                                    {% endif %}
                                                </p>
                                                <p class="mb-1"><strong>Keywords:</strong></p>
                                                <div class="view-keywords">
                                                    {% if user.keywords and user.keywords.strip() %}
                                                        {% for keyword in user.keywords.split(',') %}
                                                            {% if keyword.strip() %}
                                                            <span class="badge bg-primary me-1 mb-1">{{ keyword.strip() }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="text-muted small">No keywords selected</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                            </div>
                            
                                        <!-- Edit Mode -->
                                        <div class="info-edit-mode" style="display: none;">
                                            <div class="mb-3">
                                                <p class="text-muted small mb-0">
                                                    Customize your firm's information to personalize your generated articles.
                                                </p>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Firm Name:</strong></label>
                                                <input type="text" class="form-control form-control-sm firm-input" value="{{ user.firm }}">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Your City/Region:</strong></label>
                                                <input type="text" class="form-control form-control-sm location-input" value="{{ user.location }}">
                                </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Name:</strong></label>
                                                <input type="text" class="form-control form-control-sm lawyer-name-input" value="{{ user.lawyer_name }}">
                                    </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>State:</strong></label>
                                                <input type="text" class="form-control form-control-sm state-input" value="{{ user.state }}">
                                </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Address:</strong></label>
                                                <input type="text" class="form-control form-control-sm address-input" value="{{ user.address }}"
                                                       data-bs-toggle="tooltip" 
                                                       data-bs-placement="right" 
                                                       data-bs-html="true"
                                                       title="<strong>Examples:</strong><br>Southern California<br>Tri-state area">
                            </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Planning Session:</strong></label>
                                                <div class="form-check">
                                                    <input class="form-check-input planning-session-radio" type="radio" name="planningSession" id="planningSession1" value="Life & Legacy" {% if user.planning_session == 'Life & Legacy' %}checked{% endif %}>
                                                    <label class="form-check-label" for="planningSession1">
                                                        Life & Legacy
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input planning-session-radio" type="radio" name="planningSession" id="planningSession2" value="Family Wealth" {% if user.planning_session == 'Family Wealth' %}checked{% endif %}>
                                                    <label class="form-check-label" for="planningSession2">
                                                        Family Wealth
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input planning-session-radio" type="radio" name="planningSession" id="planningSession3" value="other" {% if user.planning_session not in ['Life & Legacy', 'Family Wealth'] %}checked{% endif %}>
                                                    <label class="form-check-label" for="planningSession3">
                                                        Other
                                                    </label>
                                                </div>
                                                <div class="mt-2 planning-session-other" {% if user.planning_session in ['Life & Legacy', 'Family Wealth'] %}style="display: none;"{% endif %}>
                                                    <input type="text" class="form-control form-control-sm planning-session-input" value="{{ user.planning_session }}" placeholder="Enter your planning session name">
                                    </div>
                                    </div>
                                                                                <div class="mb-2">
                                                <label class="form-label"><strong>Discovery Call Link:</strong></label>
                                                <input type="text" class="form-control form-control-sm discovery-call-link-input" value="{{ user.discovery_call_link }}">
                                            </div>

                                            <!-- Tone selection section -->
                                            <div class="mt-4">
                                                <!-- Standard tone options -->
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Select Writing Tone:</strong></label>
                                                    {% for tone in tone_options %}
                                                    <div class="tone-option" id="tone-option-{{ loop.index }}-{{ article_index }}">
                                                        <div class="form-check">
                                                            <input class="form-check-input tone-radio" type="radio" name="tone-{{ article_index }}" 
                                                                   id="tone-{{ loop.index }}-{{ article_index }}" value="{{ tone }}"
                                                                   data-description="{{ tone_descriptions[tone] }}"
                                                                   {% if user.selected_tone == tone %}checked{% elif loop.first and not user.selected_tone %}checked{% endif %}>
                                                            <label class="form-check-label" for="tone-{{ loop.index }}-{{ article_index }}">
                                                                <strong>{{ tone }}</strong>
                                                            </label>
                                                        </div>
                                                        <div class="tone-description small text-muted">{{ tone_descriptions[tone] }}</div>
                                                    </div>
                                                    {% endfor %}
                                                    
                                                    <!-- Create new tone option -->
                                                    <div class="tone-option" id="tone-option-new-{{ article_index }}">
                                                        <div class="form-check">
                                                            <input class="form-check-input tone-radio" type="radio" name="tone-{{ article_index }}" 
                                                                   id="tone-new-{{ article_index }}" value="custom">
                                                            <label class="form-check-label" for="tone-new-{{ article_index }}">
                                                                <strong>Create New Tone</strong>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Custom tone input section -->
                                                    <div id="customToneGroup-{{ article_index }}" class="custom-tone-container" style="display: none;">
                                                        <div class="form-floating mb-2">
                                                            <textarea class="form-control form-control-sm" id="customTone-{{ article_index }}"
                                                                      placeholder="Describe your desired tone..." style="height: 80px"></textarea>
                                                            <label for="customTone-{{ article_index }}">Describe your preferred tone</label>
                                                        </div>
                                                        
                                                        <!-- Save tone section -->
                                                        <div id="save-tone-group-{{ article_index }}" class="save-tone-container">
                                                            <div class="input-group mb-2">
                                                                <input type="text" class="form-control form-control-sm" id="tone-name-{{ article_index }}" 
                                                                       placeholder="Name for this tone">
                                                            </div>
                                                            <button type="button" class="btn btn-success btn-sm save-tone" data-index="{{ article_index }}">
                                                                <i data-feather="plus" class="icon-sm me-1"></i>Save Tone
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                                                                <!-- Keywords Section -->
                                                <div class="keyword-container">
                                                    <label class="form-label"><strong>Keywords for Blog:</strong></label>
                                                    <div class="keyword-input-group">
                                                        <input type="text" class="form-control form-control-sm" id="keyword-input-{{ article_index }}" 
                                                               placeholder="Type a keyword">
                                                        <button type="button" class="btn btn-primary btn-sm" id="add-keyword-btn-{{ article_index }}">
                                                            <i data-feather="plus" class="icon-xs"></i> Add
                                                        </button>
                                                    </div>
                                                    <input type="hidden" name="keywords-{{ article_index }}" id="keywords-hidden-{{ article_index }}">
                                                    
                                                    <div class="mb-2">
                                                        <small class="text-muted">Keywords:</small>
                                                        <div class="selected-keywords" id="selected-keywords-{{ article_index }}">
                                                            {% if user and user.keywords %}
                                                                {% for keyword in user.keywords.split(',') %}
                                                                    {% if keyword.strip() %}
                                                                    <span class="badge selected-keyword keyword-badge me-1 mb-1" data-keyword="{{ keyword.strip() }}">
                                                                        {{ keyword.strip() }}
                                                                        <span class="remove-keyword ms-1" style="cursor: pointer;">Ã—</span>
                                                                    </span>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <button type="button" class="btn btn-sm btn-primary save-info-btn w-100 mb-2">Save Changes</button>
                                                <button type="button" class="btn btn-sm btn-secondary cancel-edit-btn w-100">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}

        <div class="empty-state">
            <i data-feather="folder-x" class="icon-xl"></i>
            <h3 class="h4 mb-3">No Articles Available</h3>
            <p class="text-muted mb-4">Place your DOCX files in the content/articles/docx/ directory to get started.</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                <i data-feather="refresh-cw" class="icon-sm me-1"></i>Refresh
            </a>
        </div>
        {% endif %}

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(255, 255, 255, 0.9); z-index: 9999;">
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
                <div class="spinner-border spinner-border-sm text-dark mb-2" role="status" style="width: 2rem; height: 2rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-dark mb-0">Generating your blog...</h5>
            </div>
        </div>

        <!-- Save Message Modal -->
        <div class="modal fade" id="saveMessageModal" tabindex="-1" aria-labelledby="saveMessageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center pb-4">
                        <div id="saveMessageIcon" class="mb-3">
                            <!-- Icon will be inserted here -->
                        </div>
                        <h5 class="modal-title" id="saveMessageModalLabel">Save Status</h5>
                        <p id="saveMessageText" class="mb-0">Message will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        const toastEl = document.getElementById('toast');
        const toast = toastEl ? new bootstrap.Toast(toastEl, {autohide: true, delay: 3000}) : null;

        // Show loading overlay when form is submitted
        document.querySelectorAll('.article-form').forEach(form => {
            form.addEventListener('submit', function() {
                document.getElementById('loadingOverlay').classList.remove('d-none');
            });
        });



        // Edit information functionality
        document.querySelectorAll('.edit-info-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.card');
                const viewMode = card.querySelector('.info-view-mode');
                const editMode = card.querySelector('.info-edit-mode');
                const collapse = card.querySelector('.collapse');
                
                // Toggle visibility
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                
                // Ensure the collapse is open
                if (collapse) {
                    const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
                    bsCollapse.show();
                }

                // Load previously selected keywords
                const articleIndex = this.closest('.article-card').querySelector('.tone-radio').name.split('-')[1];
                loadSavedKeywords(articleIndex);

                // Update button state with null check
                this.classList.add('active');
                const icon = this.querySelector('i');
                if (icon) {
                    icon.setAttribute('data-feather', 'check');
                    feather.replace();
                }
            });
        });
        
        document.querySelectorAll('.cancel-edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.card');
                const viewMode = card.querySelector('.info-view-mode');
                const editMode = card.querySelector('.info-edit-mode');
                const editBtn = card.querySelector('.edit-info-btn');
                
                // Reset visibility
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
                
                // Reset button state with null check
                if (editBtn) {
                    editBtn.classList.remove('active');
                    const icon = editBtn.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-feather', 'edit-2');
                        feather.replace();
                    }
                }
            });
        });
        
        document.querySelectorAll('.save-info-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Show loading state
                const originalText = this.textContent;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
                this.disabled = true;
                
                const card = this.closest('.card');
                
                const selectedRadio = card.querySelector('input[name="planningSession"]:checked');
                let planningSession = selectedRadio ? selectedRadio.value : '';
                
                if (planningSession === 'other') {
                    const otherInput = card.querySelector('.planning-session-input');
                    planningSession = otherInput ? otherInput.value : '';
                }
                
                // Check each form element individually
                const firmInput = card.querySelector('.firm-input');
                const locationInput = card.querySelector('.location-input');
                const lawyerNameInput = card.querySelector('.lawyer-name-input');
                const stateInput = card.querySelector('.state-input');
                const addressInput = card.querySelector('.address-input');
                const discoveryCallLinkInput = card.querySelector('.discovery-call-link-input');
                
                // Get selected tone
                const selectedToneRadio = card.querySelector('input[name^="tone-"]:checked');
                const selectedTone = selectedToneRadio ? selectedToneRadio.value : '';
                const toneDescription = selectedToneRadio ? selectedToneRadio.getAttribute('data-description') : '';
                
                // Get keywords from the keywords section
                const keywordsHidden = card.querySelector('[id^="keywords-hidden-"]');
                const keywords = keywordsHidden ? keywordsHidden.value : '';
                
                const data = {
                    firm: (firmInput || {}).value || '',
                    location: (locationInput || {}).value || '',
                    lawyer_name: (lawyerNameInput || {}).value || '',
                    state: (stateInput || {}).value || '',
                    address: (addressInput || {}).value || '',
                    planning_session: planningSession,
                    discovery_call_link: (discoveryCallLinkInput || {}).value || '',
                    selected_tone: selectedTone,
                    tone_description: toneDescription,
                    keywords: keywords
                };
                
                // Send the data to the server
                
                // Send the data to the server
                fetch('/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    
                    // Reset button state
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    if (data.success) {
                        // Update the view mode with new values
                        const viewMode = card.querySelector('.info-view-mode');
                        
                        // Update fields with null checks
                        const firmValue = viewMode.querySelector('.firm-value');
                        if (firmValue) firmValue.textContent = data.firm;
                        
                        const locationValue = viewMode.querySelector('.location-value');
                        if (locationValue) locationValue.textContent = data.location;
                        
                        const lawyerNameValue = viewMode.querySelector('.lawyer-name-value');
                        if (lawyerNameValue) lawyerNameValue.textContent = data.lawyer_name;
                        
                        const stateValue = viewMode.querySelector('.state-value');
                        if (stateValue) stateValue.textContent = data.state;
                        
                        const addressValue = viewMode.querySelector('.address-value');
                        if (addressValue) addressValue.textContent = data.address;
                        
                        const planningSessionValue = viewMode.querySelector('.planning-session-value');
                        if (planningSessionValue) planningSessionValue.textContent = data.planning_session;
                        
                        const discoveryCallLinkValue = viewMode.querySelector('.discovery-call-link-value');
                        if (discoveryCallLinkValue) discoveryCallLinkValue.textContent = data.discovery_call_link;

                        // Update tone and keywords in view mode
                        const selectedToneValue = viewMode.querySelector('.selected-tone-value');
                        if (selectedToneValue) selectedToneValue.textContent = data.selected_tone || 'Professional';
                        
                        // Update tone description
                        const selectedToneDescription = viewMode.querySelector('.selected-tone-description');
                        if (selectedToneDescription) {
                            if (data.tone_description) {
                                selectedToneDescription.textContent = data.tone_description;
                            } else {
                                // Fallback to default descriptions
                                const defaultDescriptions = {
                                    'Professional': 'Formal and business-like tone suitable for corporate audiences',
                                    'Friendly': 'Warm and approachable tone that builds rapport with readers',
                                    'Educational': 'Clear and informative tone designed to explain concepts'
                                };
                                selectedToneDescription.textContent = defaultDescriptions[data.selected_tone] || 'Formal and business-like tone suitable for corporate audiences';
                            }
                        }
                        
                        const viewKeywords = viewMode.querySelector('.view-keywords');
                        if (viewKeywords) {
                            // Get keywords from the hidden input (which is updated when keywords are added/removed)
                            const keywordsHidden = card.querySelector('[id^="keywords-hidden-"]');
                            const keywords = keywordsHidden ? keywordsHidden.value : '';
                            
                            if (keywords && keywords.trim()) {
                                const keywordArray = keywords.split(',').map(k => k.trim()).filter(k => k);
                                if (keywordArray.length > 0) {
                                    viewKeywords.innerHTML = keywordArray.map(keyword => 
                                        `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                                    ).join('');
                                } else {
                                    viewKeywords.innerHTML = '<span class="text-muted small">No keywords selected</span>';
                                }
                            } else {
                                viewKeywords.innerHTML = '<span class="text-muted small">No keywords selected</span>';
                            }
                        }

                        // Switch back to view mode
                        const editMode = card.querySelector('.info-edit-mode');
                        const editBtn = card.querySelector('.edit-info-btn');
                        
                        viewMode.style.display = 'block';
                        editMode.style.display = 'none';
                        
                        // Reset button state with null checks
                        if (editBtn) {
                            editBtn.classList.remove('active');
                            const editIcon = editBtn.querySelector('i');
                            if (editIcon) {
                                editIcon.setAttribute('data-feather', 'edit-2');
                            }
                        }
                        feather.replace();

                        // Show success message
                        showSaveMessage(card, 'Changes Saved', 'success');
                    } else {
                        showSaveMessage(card, 'Failed to save changes. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Reset button state
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    showSaveMessage(card, 'Failed to save changes. Please try again.', 'error');
                });
            });
        });
        
        // Function to show save message
        function showSaveMessage(card, message, type) {
            
            const modal = document.getElementById('saveMessageModal');
            const modalInstance = new bootstrap.Modal(modal);
            const iconContainer = document.getElementById('saveMessageIcon');
            const messageText = document.getElementById('saveMessageText');
            const modalTitle = document.getElementById('saveMessageModalLabel');
            
            // Set the message text
            messageText.textContent = message;
            
            // Set the title based on type
            modalTitle.textContent = type === 'success' ? 'Success!' : 'Error';
            
            // Set the icon based on type
            if (type === 'success') {
                iconContainer.innerHTML = '<i data-feather="check-circle" style="color: #198754; width: 48px; height: 48px;"></i>';
            } else {
                iconContainer.innerHTML = '<i data-feather="alert-circle" style="color: #dc3545; width: 48px; height: 48px;"></i>';
            }
            
            // Replace feather icons
            feather.replace();
            
            // Show the modal
            modalInstance.show();
            
            // Auto-hide modal after 3 seconds
            setTimeout(() => {
                modalInstance.hide();
            }, 3000);
        }
    
        // Filter button click handler
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filterType = this.dataset.filter;
                filterArticles(filterType, this);
            });
        });

        // Initialize with 'latest' filter
            const defaultFilter = document.querySelector('.filter-btn[data-filter="latest"]');
            if (defaultFilter) defaultFilter.click();

        function filterArticles(filterType, clickedButton) {
            const articlesContainer = document.querySelector('.row');
            const articles = Array.from(document.querySelectorAll('.article-card'));
            
            // First, reset all articles to visible and remove any previous hiding
            articles.forEach(article => {
                article.style.display = 'block';
                article.parentElement.style.display = 'block';
            });
            
            if (filterType === 'latest') {
                // Object to track the highest series_order article for each series
                const latestSeriesArticles = {};
                
                // First pass - find the article with highest series_order for each series
                articles.forEach(article => {
                    const series = article.dataset.series;
                    const seriesOrder = parseInt(article.dataset.seriesIndex) || 0;
                    
                    if (series !== 'none') {
                        if (!latestSeriesArticles[series] || 
                            seriesOrder > latestSeriesArticles[series].order) {
                            latestSeriesArticles[series] = {
                                element: article,
                                order: seriesOrder
                            };
                        }
                    }
                });
                
                // Second pass - hide non-latest series articles
                articles.forEach(article => {
                    const series = article.dataset.series;
                    
                    if (series === 'none') {
                        // Non-series article - always show
                        article.style.display = 'block';
                        article.parentElement.style.display = 'block';
                    } else {
                        // Series article - show only if it has the highest series_order
                        if (latestSeriesArticles[series] && article === latestSeriesArticles[series].element) {
                            article.style.display = 'block';
                            article.parentElement.style.display = 'block';
                        } else {
                            article.style.display = 'none';
                            article.parentElement.style.display = 'none';
                        }
                    }
                });
            }
            else if (filterType === 'all') {
                // Show all articles - already handled by the initial reset
            }
            else if (filterType.startsWith('series-')) {
                // Show only articles from the selected series
                const targetSeries = clickedButton.dataset.series;
                
                articles.forEach(article => {
                    if (article.dataset.series === targetSeries) {
                        article.style.display = 'block';
                        article.parentElement.style.display = 'block';
                    } else {
                        article.style.display = 'none';
                        article.parentElement.style.display = 'none';
                    }
                });
            }
            
            // Force reflow to trigger any CSS transitions
            void articlesContainer.offsetWidth;
        }
        
        // Preview functionality
        const previewDialog = document.getElementById('previewDialog');
        const previewOverlay = document.getElementById('previewOverlay');
        const previewContent = document.getElementById('previewContent');
        const closePreview = document.getElementById('closePreview');

        // Function to load article content
        async function loadArticleContent(article) {
            try {
                const response = await fetch(`/preview_article/${article}`);
                if (!response.ok) throw new Error('Failed to load article');
                const data = await response.json();
                previewContent.innerHTML = data.content;
                feather.replace();
            } catch (error) {
                console.error('Error loading article:', error);
                previewContent.innerHTML = '<div class="alert alert-danger">Failed to load article preview</div>';
            }
        }

        // Open preview
        document.querySelectorAll('.preview-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const article = this.dataset.article;
                loadArticleContent(article);
                previewDialog.classList.add('active');
                previewOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });

        // Close preview
        function closePreviewDialog() {
            previewDialog.classList.remove('active');
            previewOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        closePreview.addEventListener('click', closePreviewDialog);
        previewOverlay.addEventListener('click', closePreviewDialog);

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && previewDialog.classList.contains('active')) {
                closePreviewDialog();
            }
        });

        // Handle planning session radio buttons
        document.querySelectorAll('.planning-session-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const card = this.closest('.card');
                const otherInput = card.querySelector('.planning-session-other');
                if (this.value === 'other') {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                    card.querySelector('.planning-session-input').value = this.value;
                }
            });
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Tone selection functionality
        document.querySelectorAll('.tone-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const articleIndex = this.name.split('-')[1];
                const customToneGroup = document.getElementById(`customToneGroup-${articleIndex}`);
                
                if (this.value === 'custom') {
                    customToneGroup.style.display = 'block';
                } else {
                    customToneGroup.style.display = 'none';
                }
            });
        });

        // Save custom tone functionality
        document.querySelectorAll('.save-tone').forEach(button => {
            button.addEventListener('click', function() {
                const articleIndex = this.dataset.index;
                const toneName = document.getElementById(`tone-name-${articleIndex}`).value.trim();
                const toneDescription = document.getElementById(`customTone-${articleIndex}`).value.trim();
                
                if (!toneName || !toneDescription) {
                    alert('Please provide both a tone name and description.');
                    return;
                }
                
                fetch('/add_tone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tone_name: toneName,
                        tone_description: toneDescription
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the radio button to use the new tone
                        const customRadio = document.getElementById(`tone-new-${articleIndex}`);
                        customRadio.value = toneName;
                        customRadio.setAttribute('data-description', toneDescription);
                        
                        // Update the label
                        const label = customRadio.nextElementSibling;
                        label.innerHTML = `<strong>${toneName}</strong>`;
                        
                        // Add description
                        const toneOption = customRadio.closest('.tone-option');
                        let descriptionDiv = toneOption.querySelector('.tone-description');
                        if (!descriptionDiv) {
                            descriptionDiv = document.createElement('div');
                            descriptionDiv.className = 'tone-description small text-muted';
                            toneOption.appendChild(descriptionDiv);
                        }
                        descriptionDiv.textContent = toneDescription;
                        
                        // Clear inputs
                        document.getElementById(`tone-name-${articleIndex}`).value = '';
                        document.getElementById(`customTone-${articleIndex}`).value = '';
                        document.getElementById(`customToneGroup-${articleIndex}`).style.display = 'none';
                        
                        // Select the new tone
                        customRadio.checked = true;
                        
                        showSaveMessage(card, 'Custom tone saved successfully!', 'success');
                    } else {
                        showSaveMessage(card, data.error || 'Failed to save tone.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showSaveMessage(card, 'Failed to save tone. Please try again.', 'error');
                });
            });
        });

        // Keywords functionality
        document.querySelectorAll('[id^="add-keyword-btn-"]').forEach(button => {
            button.addEventListener('click', function() {
                const articleIndex = this.id.split('-').pop();
                const keywordInput = document.getElementById(`keyword-input-${articleIndex}`);
                const keyword = keywordInput.value.trim();
                
                if (!keyword) {
                    alert('Please enter a keyword.');
                    return;
                }
                
                addKeyword(articleIndex, keyword);
                keywordInput.value = '';
            });
        });

        // Allow Enter key to add keywords
        document.querySelectorAll('[id^="keyword-input-"]').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const articleIndex = this.id.split('-').pop();
                    const keyword = this.value.trim();
                    
                    if (keyword) {
                        addKeyword(articleIndex, keyword);
                        this.value = '';
                    }
                }
            });
        });

        // Remove keywords
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-keyword')) {
                e.preventDefault();
                e.stopPropagation();
                const keywordBadge = e.target.closest('.keyword-badge');
                const articleCard = keywordBadge.closest('.article-card');
                const articleIndex = articleCard.querySelector('.tone-radio').name.split('-')[1];
                keywordBadge.remove();
                updateKeywordsHidden(articleIndex);
            }
        });

        function addKeyword(articleIndex, keyword) {
            const selectedKeywordsDiv = document.getElementById(`selected-keywords-${articleIndex}`);
            const keywordsHidden = document.getElementById(`keywords-hidden-${articleIndex}`);
            
            // Check if keyword already exists
            const existingKeywords = selectedKeywordsDiv.querySelectorAll('.keyword-badge');
            for (let existing of existingKeywords) {
                if (existing.dataset.keyword === keyword) {
                    return; // Keyword already exists
                }
            }
            
            // Create keyword badge
            const keywordBadge = document.createElement('span');
            keywordBadge.className = 'badge selected-keyword keyword-badge me-1 mb-1';
            keywordBadge.dataset.keyword = keyword;
            keywordBadge.textContent = keyword;
            
            // Add remove button
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-keyword ms-1';
            removeBtn.innerHTML = '&times;';
            removeBtn.style.cursor = 'pointer';
            
            keywordBadge.appendChild(removeBtn);
            selectedKeywordsDiv.appendChild(keywordBadge);
            
            updateKeywordsHidden(articleIndex);
        }

        function updateKeywordsHidden(articleIndex) {
            const selectedKeywordsDiv = document.getElementById(`selected-keywords-${articleIndex}`);
            const keywordsHidden = document.getElementById(`keywords-hidden-${articleIndex}`);
            
            const keywords = Array.from(selectedKeywordsDiv.querySelectorAll('.keyword-badge'))
                .map(badge => badge.dataset.keyword);
            
            keywordsHidden.value = keywords.join(',');
        }

        function loadSavedKeywords(articleIndex) {
            // Get user's saved keywords from the server response
            const userKeywords = '{{ user.keywords or "" }}';
            if (userKeywords && userKeywords.trim()) {
                const keywords = userKeywords.split(',').map(k => k.trim()).filter(k => k);
                // Update the hidden input first
                const keywordsHidden = document.getElementById(`keywords-hidden-${articleIndex}`);
                if (keywordsHidden) {
                    keywordsHidden.value = keywords.join(',');
                }
                // Then add the visual badges
                keywords.forEach(keyword => {
                    addKeyword(articleIndex, keyword);
                });
            }
        }


    });
</script>
{% endblock %}